#!/usr/bin/env node

const assert = require('assert');
const args = require('minimist')(process.argv.slice(2));

const Updater = require('../lib/update');

try {
  assert(args.repo, '`--repo` is required');
  assert(args.token, '`--file` is required');
  assert(args.token, '`--token` is required');
  assert(args.service, '`--service` is required');

  if (typeof args.service === "string") {
    assert(args.version, '`--version` is required when updating single service');
    args.service = [`${args.service}:${args.version}`];
  }
  assert(Array.isArray(args.service), '`--service` must be a string or an array of strings');
  assert(args.service.length > 0, 'must provide at least one option for `--service`');

  args.services = args.service.map((s) => {
    assert(typeof s === 'string', '`--service` must be a string or an array of strings');
    const [name, version] = s.split(':');
    assert(name, 'service name is required');
    assert(version, 'service version is required');
    return { name, version };
  })
} catch (e) {
  console.error(e.message);
  process.exit(1);
}

const updater = Updater({
  repo: args.repo,
  token: args.token,
  file: args.file,
  branch: args.branch || 'master'
});

updater.update(args.services)
  .catch((e) => {
    console.error(e);
    process.exit(1);
  });
